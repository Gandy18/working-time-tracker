<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Working Time Tracker</title>

    <!-- ===================================== -->
    <!--               CSS START               -->
    <!-- ===================================== -->

    <style>
      /* --------------------------------------------------
        THEME VARIABLES
      -------------------------------------------------- */
      :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --text-color: #222222;
        --subtext-color: #555555;
        --accent-color: #0078ff;
        --button-text: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e0e0e0;

        --btn-secondary-bg: rgba(0, 0, 0, 0.05);
        --btn-secondary-border: #d0d0d0;

        --toggle-bg: #d0d0d0;
        --toggle-thumb: #ffffff;

        --break-banner-bg: #f9e23a;
        --break-banner-text: #000000;

        --green-ok: #238823;
        /* --yellow-warn: #ffbf00; */
        --yellow-warn: #f6ba07;
        --red-danger: #d2222d;
      }

      :root.dark {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e6e6e6;
        --subtext-color: #aaaaaa;
        --accent-color: #116ecb;
        --button-text: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.6);
        --border-color: #333333;

        --btn-secondary-bg: rgba(255, 255, 255, 0.06);
        --btn-secondary-border: #444444;

        --toggle-bg: #444444;
        --toggle-thumb: #1e1e1e;

        --break-banner-bg: #f9e23a;
        --break-banner-text: #000000;

        --green-ok: #81c784;
        --yellow-warn: #ffd54f;
        --red-danger: #e53935;
      }

      /* --------------------------------------------------
        GLOBAL
      -------------------------------------------------- */
      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 16px;
        background: var(--bg-color);
        color: var(--text-color);
        transition:
          background 0.2s ease,
          color 0.2s ease;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .app-container {
        max-width: 480px;
        margin: 0 auto;
      }

      /* --------------------------------------------------
        HEADER + THEME TOGGLE
      -------------------------------------------------- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      h2 {
        font-size: 20px;
        margin: 0;
      }

      .theme-toggle {
        width: 48px;
        height: 24px;
        background: var(--toggle-bg);
        border-radius: 999px;
        position: relative;
        cursor: pointer;
        transition: background 0.25s ease;
      }

      .toggle-thumb {
        width: 22px;
        height: 22px;
        background: var(--toggle-thumb);
        border-radius: 50%;
        position: absolute;
        top: 1px;
        left: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition:
          left 0.25s ease,
          background 0.25s ease;
      }

      .theme-toggle.dark .toggle-thumb {
        left: 25px;
      }

      /* --------------------------------------------------
        CARDS + TEXT
      -------------------------------------------------- */
      .card {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--card-bg);
        padding: 16px 18px;
        margin-bottom: 14px;
        border-radius: 14px;
        box-shadow: 0 4px 10px var(--shadow-color);
        border: 1px solid var(--border-color);
        transition:
          background 0.2s ease,
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }

      .label {
        font-weight: 600;
        margin-top: 6px;
        margin-bottom: 4px;
        font-size: 14px;
        color: var(--subtext-color);
      }

      .label-heading {
        font-size: 16px;
        font-weight: 700;
        margin: 0;
        text-align: center;
      }

      .label-heading-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-bottom: 0;
        align-self: center;
      }

      .value {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .big-number {
        font-size: 40px;
        font-weight: 700;
        margin: 0;
        text-align: center;
      }

      .subtext {
        font-size: 14px;
        color: var(--subtext-color);
        margin-bottom: 2px;
        line-height: 1.2;
        text-align: center;
      }

      /* --------------------------------------------------
        BUTTONS
      -------------------------------------------------- */
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      /* Keep the summary button unchanged (fit-content) */
      .summary-btn { width: fit-content; padding-left: 20px; padding-right: 20px; }

      button {
        padding: 10px 14px;
        font-size: 15px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        flex: 1 1 30%;
        min-width: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: nowrap;
        transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
        box-shadow: 0 2px 6px var(--shadow-color);
      }

      button:active {
        transform: scale(0.97);
      }

      .active-break { 
        background: #ccc !important; 
        color: #000 !important; 
        border: none !important; 
        font-size: 15px; 
        font-weight: 500; 
      }

      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
        filter: grayscale(40%);
      }

      .btn-primary {
        background: var(--accent-color);
        color: var(--button-text);
      }

      .btn-secondary {
        background: var(--btn-secondary-bg);
        color: var(--text-color);
        border: 1px solid var(--btn-secondary-border);
      }

      .btn-grey {
        background: #ccc;
        color: #000;
        border-radius: 6px;
        padding: 10px 16px;
        font-size: 15px;
        font-weight: 500;
      }

      .end-shift {
        background: #cb3d3a;
        color: #fff;
      }

      /* --------------------------------------------------
        BREAK BANNER
      -------------------------------------------------- */
      .break-banner { 
        background: var(--break-banner-bg); 
        color: var(--break-banner-text); 
        padding: 10px; 
        border-radius: 10px; 
        margin-bottom: 14px; 
        font-weight: 600; 
        box-shadow: 0 2px 6px var(--shadow-color); 
        display: flex; 
        justify-content: center;
        align-items: center;
      }
      
      .break-center { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        width: 100%; 
        box-sizing: border-box; 
        max-width: 640px; 
      }
      
      .break-text { 
        display: inline-flex; 
        align-items: center; 
        white-space: nowrap; 
      } 
      
      .break-icon-img { 
        width: 24px;
        height: 24px; 
        object-fit: contain; 
        display: inline-block; 
      }

      /* --------------------------------------------------
        TIME GRID
      -------------------------------------------------- */
      .time-grid {
        display: flex;
        justify-content: center;
        gap: 24px;
      }

      .time-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
        text-align: center;
      }

      .time-col .label {
        font-size: 15px;
      }

      .time-col .value {
        font-size: 26px;
      }

      /* --------------------------------------------------
        PROGRESS BAR
      -------------------------------------------------- */
      .progress-container {
        width: 100%;
        height: 10px;
        background: #ddd;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 12px;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        width: 0%;
        background: var(--accent-color);
        transition: width 0.4s ease;
      }

      .progress-splits {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .progress-splits span {
        position: absolute;
        width: 2px;
        height: 100%;
        background: #888;
        transform: translateX(-0.5px);
      }

      .progress-markers {
        position: relative;
        height: 16px;
        margin-top: 4px;
      }

      .progress-markers span {
        position: absolute;
        transform: translateX(-50%);
        font-size: 12px;
        color: var(--subtext-color);
      }

      /* --------------------------------------------------
        UNIFIED MODAL SYSTEM (OLD VISUAL STYLE)
      -------------------------------------------------- */

      /* Modal box */
      .modal {
        background: var(--card-bg);
        color: var(--text-color);
        padding: 20px;
        border-radius: 12px;
        width: 85%;
        max-width: 360px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      /* Buttons inside modals */
      .modal-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      .modal-btn {
        flex: 1;
        padding: 10px;
        margin: 0 6px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
      }

      .modal-btn.cancel {
        background: var(--accent-color);
        color: var(--button-text);
        border: none; 
      }

      .modal-btn.confirm {
        background: #cb3d3a;
        color: #fff;
      }

      /* Ensure modal overlay is centered and hidden by default */
      .modal-overlay { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.5); 
        justify-content: center; 
        align-items: center; 
        z-index: 999; 
      }

      /* Compact modal action buttons (match working file) */
      .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        justify-content: center;
        align-items: center;
      }

      /* Default modal action button sizing (compact) */
      .modal-buttons .modal-btn {
        flex: 0 1 auto;        /* don't force full width */
        min-width: 110px;      /* keeps buttons readable on small screens */
        padding: 8px 12px;     /* compact padding */
        border-radius: 8px;    /* same rounded look as summary button */
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 2px 6px var(--shadow-color);
      }

      /* Grey primary-like button (same as summary) */
      .modal-btn.btn-grey {
        background: #ccc;
        color: #000;
        border: none;
      }

      /* Confirm / danger button compact style */
      .modal-btn.confirm {
        background: #cb3d3a;
        color: #fff;
        border: none;
      }

      /* Keep the cancel full-width row unchanged */
      .modal-cancel-row { margin-top: 12px; display: flex; }
      .modal-cancel-row .modal-btn { width: 100%; padding: 10px 14px; }

      /* Small-screen fallback: allow wrapping but keep compact buttons */
      @media (max-width: 420px) {
        .modal-buttons { flex-wrap: wrap; gap: 8px; }
        .modal-buttons .modal-btn { min-width: 100px; flex: 1 1 45%; }
        .modal-cancel-row .modal-btn { padding: 10px 12px; }
      }

      /* Buttons row for save options */
      .save-options-row { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 10px; 
        justify-content: center; 
        margin-top: 12px; 
      }
      .save-options-row .modal-btn { 
        flex: 1 1 45%; 
        min-width: 140px; 
      }

      /* Cancel row: full width button at bottom */
      .modal-cancel-row { 
        margin-top: 14px; 
        display: flex; 
      }
      .modal-cancel-row .modal-btn { 
        width: 100%; 
      }

      /* Utility class for full width button */
      .full-width { 
        width: 100%; 
      }

      /* Visual tweaks */
      .modal-btn { 
        padding: 10px 12px; 
        border-radius: 8px; 
        font-size: 15px; 
      }

      /* Full-width cancel row for consistency with Save Options modal */
      .modal-cancel-row { margin-top: 12px; display: flex; }
      .modal-cancel-row .modal-btn { width: 100%; }

      /* Utility class used elsewhere */
      .full-width { width: 100%; }

      /* Ensure modal-buttons layout for save/delete matches other modals */
      .save-delete-row { display:flex; gap:10px; margin-top:12px; }
      .save-delete-row .modal-btn { flex: 1; }

      /* Make summary modal scrollable when content is long */
      #summaryModal .modal {
        max-height: 80vh;        /* modal never exceeds screen height */
        overflow-y: auto;        /* scrolls internally */
        padding-bottom: 20px;    /* keeps bottom spacing comfortable */
      }

      /* Small-screen fallback: stack save/delete vertically under 420px */
      @media (max-width: 420px) {
        .save-delete-row { flex-direction: column; gap: 8px; }
      }

      /* Small-screen behaviour: stack save options vertically under 420px */
      @media (max-width: 420px) {
        .save-options-row .modal-btn { flex: 1 1 100%; min-width: 0; }
      }

      /* --------------------------------------------------
        INFO BUTTON
      -------------------------------------------------- */
      .info-btn {
        background: var(--btn-secondary-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 14px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
        flex: 0 0 auto; /* prevent stretching, match old behaviour */
      }

      /* --------------------------------------------------
        SUMMARY BUTTON
      -------------------------------------------------- */
      .summary-row {
        display: flex;
        justify-content: center;
        margin-top: 8px;
      }

      .summary-btn {
        margin-top: 12px;
        width: fit-content;
        padding-left: 20px;
        padding-right: 20px;
      }

      /* --------------------------------------------------
        STATUS COLOURS
      -------------------------------------------------- */
      .good {
        color: var(--green-ok);
      }
      .warning {
        color: var(--yellow-warn);
      }
      .danger {
        color: var(--red-danger);
      }

      .break-ok {
        color: var(--green-ok);
      }
      .break-low {
        color: var(--red-danger);
      }

      .break-timer-red {
        color: var(--red-danger);
      }
      .break-timer-green {
        color: var(--green-ok);
      }

      .break-req-green {
        color: var(--green-ok);
      }

      .break-req-red {
        color: var(--red-danger);
      }

      .break-center {
        display: flex;
        align-items: center;
        gap: 8px;
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <header>
        <h2>Working Time Tracker</h2>

        <div id="themeToggle" class="theme-toggle">
          <div class="toggle-thumb">ðŸŒ™</div>
        </div>
      </header>

      <div id="breakBanner" class="break-banner" style="display: none">
        <div class="break-center">
          <span class="break-text">BREAK IN PROGRESS</span>
          <img src="assets/stopwatch.png" class="break-icon-img" alt="">
        </div>
      </div>

      <div class="card">
        <div class="button-row">
          <button id="startShiftBtn" class="btn-primary">Start Shift</button>
          <button id="startBreakBtn" class="btn-secondary">Start Break</button>
          <button id="endBreakBtn" class="btn-secondary" disabled>
            End Break
          </button>
        </div>
      </div>

      <div class="card">
        <div class="label-heading-row">
          <div class="label-heading">Break Requirement</div>
          <button id="breakInfoBtn" class="info-btn">i</button>
        </div>
        <div class="subtext">
          Before the end of your shift, you must take a TOTAL break of:
        </div>
        <div id="breakRequirementNumber" class="big-number">0 minutes</div>
      </div>

      <div class="card">
        <div class="time-grid">
          <div class="time-col">
            <div class="label">Since shift start</div>
            <div class="value" id="elapsed">00:00:00</div>

            <div class="label">Current break</div>
            <div class="value" id="currentBreak">00:00:00</div>
          </div>

          <div class="time-col">
            <div class="label">Since last break</div>
            <div class="value" id="sinceLastBreak">00:00:00</div>

            <div class="label">Total break time</div>
            <div class="value" id="breakTaken">00:00:00</div>
          </div>
        </div>

        <div class="summary-row">
          <button id="summaryBtn" class="summary-btn btn-grey">Summary</button>
        </div>
      </div>

      <div class="card">
        <div class="time-grid">
          <div class="time-col">
            <div class="label">Time until <strong>6 hours</strong></div>
            <div class="value" id="sixHour">00:00:00</div>

            <div class="label">Time until <strong>12 hours</strong></div>
            <div class="value" id="twelveHour">00:00:00</div>
          </div>

          <div class="time-col">
            <div class="label">Time until <strong>9 hours</strong></div>
            <div class="value" id="nineHour">00:00:00</div>

            <div class="label">Time until <strong>15 hours</strong></div>
            <div class="value" id="fifteenHour">00:00:00</div>
          </div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-splits">
          <span style="left: 20%"></span>
          <!-- 3h -->
          <span style="left: 40%"></span>
          <!-- 6h -->
          <span style="left: 60%"></span>
          <!-- 9h -->
          <span style="left: 80%"></span>
          <!-- 12h -->
        </div>
        <div class="progress-bar" id="shiftProgress"></div>
      </div>

      <div class="progress-markers">
        <span style="left: 0%">0h</span>
        <span style="left: 20%">3h</span>
        <span style="left: 40%">6h</span>
        <span style="left: 60%">9h</span>
        <span style="left: 80%">12h</span>
        <span style="left: 100%">15h</span>
      </div>

      <!-- End / Save or Delete modal -->
      <div id="endShiftModal" class="modal-overlay">
        <div class="modal">
          <h2>Save or Delete Shift Data</h2>
          <p>Do you want to save the data for this shift or delete the data and reset timers?</p>

          <div class="modal-buttons save-delete-row">
            <button id="saveShiftBtn" class="modal-btn btn-grey">Save</button>
            <button id="deleteShiftBtn" class="modal-btn confirm">Delete</button>
          </div>

          <div class="modal-cancel-row">
            <button id="cancelEndShiftModal" class="modal-btn cancel full-width">Cancel</button>
          </div>
        </div>
      </div>

      <div id="saveOptionsModal" class="modal-overlay">
        <div class="modal">
          <h2>Save Shift Data</h2>
          <p>Choose how you'd like to save your shift summary:</p>

          <div class="modal-buttons save-options-row">
            <button id="saveEmail" class="modal-btn btn-grey">Email</button>
            <button id="saveWhatsApp" class="modal-btn btn-grey">WhatsApp</button>
            <button id="saveTextFile" class="modal-btn btn-grey">Text File</button>
          </div>

          <div class="modal-cancel-row">
            <button id="closeSaveOptions" class="modal-btn cancel full-width">Cancel</button>
          </div>
        </div>
      </div>

      <div id="breakInfoModal" class="modal-overlay">
        <div class="modal">
          <h2>Break Information</h2>

          <p>
            Only breaks of <strong>15 minutes or more</strong> are counted
            toward your required break time.
          </p>

          <h3>Break Thresholds</h3>
          <ul style="text-align: left; padding-left: 20px">
            <li><strong>0â€“3 hours:</strong> No break required</li>
            <li><strong>3â€“6 hours:</strong> 15 minutes</li>
            <li><strong>6â€“9 hours:</strong> 30 minutes</li>
            <li><strong>9+ hours:</strong> 45 minutes</li>
          </ul>

          <div class="modal-buttons">
            <button id="closeBreakInfo" class="modal-btn cancel">Close</button>
          </div>
        </div>
      </div>

      <div id="summaryModal" class="modal-overlay">
        <div class="modal">
          <h2>Break Summary</h2>

          <div id="summaryContent"></div>

          <div class="modal-buttons">
            <button id="summaryClose" class="modal-btn cancel">Close</button>
          </div>
        </div>

    <!-- ===================================== -->
    <!--            JAVASCRIPT START           -->
    <!-- ===================================== -->

    <script>
      (function () {
        // THEME TOGGLE
        const root = document.documentElement;
        const toggle = document.getElementById("themeToggle");
        const thumb = toggle.querySelector(".toggle-thumb");

        function applyTheme(theme) {
          if (theme === "dark") {
            root.classList.add("dark");
            toggle.classList.add("dark");
            thumb.textContent = "ðŸ”†";
          } else {
            root.classList.remove("dark");
            toggle.classList.remove("dark");
            thumb.textContent = "ðŸŒ™";
          }
          localStorage.setItem("wtdTheme", theme);
        }

        const savedTheme = localStorage.getItem("wtdTheme") || "light";
        applyTheme(savedTheme);

        toggle.addEventListener("click", () => {
          const current = root.classList.contains("dark") ? "dark" : "light";
          applyTheme(current === "dark" ? "light" : "dark");
        });

        // STATE
        let startTime = Number(localStorage.getItem("shiftStartTime")) || null;
        let shiftEndTime = null;
        let breakLog = JSON.parse(localStorage.getItem("breakLog") || "[]");
        let currentBreakStart =
          Number(localStorage.getItem("currentBreakStart")) || null;

        // Filter out short breaks from stored log
        breakLog = breakLog.filter((b) => b.end - b.start >= 15 * 60 * 1000);
        localStorage.setItem("breakLog", JSON.stringify(breakLog));

        let timerInterval = null;

        // UI HELPERS
        function updateBreakButtons() {
          const startBtn = document.getElementById("startBreakBtn");
          const endBtn = document.getElementById("endBreakBtn");
          const banner = document.getElementById("breakBanner");

          if (!startTime) {
            startBtn.disabled = true;
            endBtn.disabled = true;
            banner.style.display = "none";
            return;
          }

          if (currentBreakStart) {
            startBtn.disabled = true;
            endBtn.disabled = false;

            startBtn.classList.remove("active-break");
            endBtn.classList.add("active-break");

            banner.style.display = "block";
          } else {
            startBtn.disabled = false;
            endBtn.disabled = true;

            startBtn.classList.add("active-break");
            endBtn.classList.remove("active-break");

            banner.style.display = "none";
          }
        }

        // Helper: ordinal suffix for day numbers
        function dayOrdinal(n) {
          const s = ["th","st","nd","rd"];
          const v = n % 100;
          return n + (s[(v-20)%10] || s[v] || s[0]);
        }

        // Helper: format date like "Tue 10th Feb 2026"
        function formatDateWithOrdinal(ms) {
          if (!ms) return "--";
          const d = new Date(ms);
          // weekday and month short names from locale
          const weekday = d.toLocaleDateString("en-GB", { weekday: "short" }); // e.g. "Tue"
          const month = d.toLocaleDateString("en-GB", { month: "short" });     // e.g. "Feb"
          const year = d.getFullYear();                                        // e.g. 2026
          const dayWithOrd = dayOrdinal(d.getDate());                          // e.g. "10th"
          return `${weekday} ${dayWithOrd} ${month} ${year}`;                  // "Tue 10th Feb 2026"
        }

        function formatHMS(ms) {
          const totalSeconds = Math.floor(ms / 1000);
          const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
          const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(
            2,
            "0",
          );
          const s = String(totalSeconds % 60).padStart(2, "0");
          return `${h}:${m}:${s}`;
        }

        function calculateCurrentBreak(now) {
          if (!currentBreakStart) return 0;
          return now - currentBreakStart;
        }

        function calculateBreakTaken() {
          let total = 0;
          breakLog.forEach((b) => (total += b.end - b.start));
          return total;
        }

        function calculateTimeSinceLastBreak(now) {
          if (breakLog.length > 0) {
            const last = breakLog[breakLog.length - 1];
            return now - last.end;
          }
          if (!startTime) return 0;
          return now - startTime;
        }

        // BREAK REQUIREMENT LOGIC
        function getBreakRequirementMinutes(elapsedMs) {
          const h = elapsedMs / 3600000;

          if (h <= 3) return 0;
          if (h <= 6) return 15;
          if (h <= 9) return 30;
          return 45;
        }

        // PROGRESS BAR FUNCTION
        function updateShiftProgress(elapsedMs) {
          const maxMs = 15 * 3600000;
          const pct = Math.min((elapsedMs / maxMs) * 100, 100);
          document.getElementById("shiftProgress").style.width = pct + "%";
        }

        function startTimers() {
          if (timerInterval) clearInterval(timerInterval);

          timerInterval = setInterval(() => {
            if (!startTime) return;

            const now = Date.now();
            const elapsedMs = now - startTime;

            updateShiftProgress(elapsedMs);

            document.getElementById("elapsed").textContent =
              formatHMS(elapsedMs);

            const currentBreakMs = calculateCurrentBreak(now);
            const currentBreakEl = document.getElementById("currentBreak");

            currentBreakEl.textContent = formatHMS(currentBreakMs);

            currentBreakEl.classList.remove(
              "break-timer-red",
              "break-timer-green",
            );

            if (currentBreakMs === 0) {
              // no break
            } else if (currentBreakMs < 15 * 60 * 1000) {
              currentBreakEl.classList.add("break-timer-red");
            } else {
              currentBreakEl.classList.add("break-timer-green");
            }

            const breakTakenMs = calculateBreakTaken();
            const breakTakenEl = document.getElementById("breakTaken");
            breakTakenEl.textContent = formatHMS(breakTakenMs);

            const requiredMinutes = getBreakRequirementMinutes(elapsedMs);
            const requiredMs = requiredMinutes * 60 * 1000;

            breakTakenEl.classList.remove("break-ok", "break-low");
            if (breakTakenMs >= requiredMs) {
              breakTakenEl.classList.add("break-ok");
            } else {
              breakTakenEl.classList.add("break-low");
            }

            const sinceLastBreakMs = calculateTimeSinceLastBreak(now);
            const sinceEl = document.getElementById("sinceLastBreak");
            sinceEl.textContent = formatHMS(sinceLastBreakMs);

            sinceEl.classList.remove("good", "warning", "danger");

            if (sinceLastBreakMs < 5 * 60 * 60 * 1000) {
              sinceEl.classList.add("good");
            } else if (sinceLastBreakMs < 5.5 * 60 * 60 * 1000) {
              sinceEl.classList.add("warning");
            } else {
              sinceEl.classList.add("danger");
            }

            const breakReqEl = document.getElementById(
              "breakRequirementNumber",
            );
            breakReqEl.textContent = `${requiredMinutes} minutes`;

            breakReqEl.classList.remove("break-req-green", "break-req-red");

            if (breakTakenMs >= requiredMinutes * 60 * 1000) {
              breakReqEl.classList.add("break-req-green");
            } else {
              breakReqEl.classList.add("break-req-red");
            }

            const thresholds = [
              { hours: 6, id: "sixHour" },
              { hours: 9, id: "nineHour" },
              { hours: 12, id: "twelveHour" },
              { hours: 15, id: "fifteenHour" },
            ];

            thresholds.forEach((t) => {
              const limit = t.hours * 3600000;
              const left = limit - elapsedMs;
              const el = document.getElementById(t.id);

              el.textContent = left > 0 ? formatHMS(left) : "00:00:00";

              el.classList.remove("good", "warning", "danger");
              if (left <= 0) el.classList.add("danger");
              else if (left < 60 * 60 * 1000) el.classList.add("warning");
              else el.classList.add("good");
            });
          }, 1000);
        }

        // START / END SHIFT
        function startShift() {
          startTime = Date.now();
          localStorage.setItem("shiftStartTime", startTime);

          breakLog = [];
          currentBreakStart = null;

          shiftEndTime = null;

          localStorage.setItem("breakLog", JSON.stringify(breakLog));
          localStorage.removeItem("currentBreakStart");

          updateBreakButtons();
          startTimers();

          const btn = document.getElementById("startShiftBtn");
          btn.textContent = "End Shift";
          btn.classList.add("end-shift");
        }

        function confirmEndShift() {
          document.getElementById("endShiftModal").style.display = "flex";
        }

        function endShift() {
          startTime = null;
          breakLog = [];
          currentBreakStart = null;

          localStorage.removeItem("shiftStartTime");
          localStorage.removeItem("breakLog");
          localStorage.removeItem("currentBreakStart");

          clearInterval(timerInterval);
          timerInterval = null;

          document.getElementById("elapsed").textContent = "00:00:00";
          document.getElementById("currentBreak").textContent = "00:00:00";
          document.getElementById("breakTaken").textContent = "00:00:00";
          document.getElementById("sinceLastBreak").textContent = "00:00:00";

          ["sixHour", "nineHour", "twelveHour", "fifteenHour"].forEach((id) => {
            document.getElementById(id).textContent = "00:00:00";
          });

          document.getElementById("breakRequirementNumber").textContent =
            "0 minutes";

          const colourIds = [
            "elapsed",
            "currentBreak",
            "breakTaken",
            "sinceLastBreak",
            "sixHour",
            "nineHour",
            "twelveHour",
            "fifteenHour",
          ];

          colourIds.forEach((id) => {
            const el = document.getElementById(id);
            el.classList.remove(
              "good",
              "warning",
              "danger",
              "break-ok",
              "break-low",
            );
          });

          const btn = document.getElementById("startShiftBtn");
          btn.textContent = "Start Shift";
          btn.classList.remove("end-shift");

          updateBreakButtons();
        }

        // TEXT SUMMARY FOR SAVE OPTIONS
        function formatTime24(ms) {
          if (!ms) return "--:--";
          const d = new Date(ms);
          return d.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        function formatDuration(ms) {
          if (!ms) return "--:--";
          const mins = Math.floor(ms / 60000);
          const secs = Math.floor((ms % 60000) / 1000);
          return `${String(mins).padStart(2, "0")}:${String(secs).padStart(
            2,
            "0",
          )}`;
        }

        function formatHM(ms) {
          if (!ms) return "--:--";
          const totalMinutes = Math.floor(ms / 60000);
          const h = Math.floor(totalMinutes / 60);
          const m = totalMinutes % 60;
          return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
        }

        function ordinal(n) {
          return n === 1 ? "1st" : n === 2 ? "2nd" : n === 3 ? "3rd" : `${n}th`;
        }

        function generateShiftTextSummary() {
          let text = "";

          // SHIFT START
          text += `Shift Start Date: ${
            startTime ? formatDateWithOrdinal(startTime) : "--"
          }\n`;
          text += `Shift Start Time: ${
            startTime ? formatTime24(startTime) : "--:--"
          }\n\n`;

          // BREAKS
          if (breakLog.length === 0) {
            text += `1st Break:\nStart: --:--\nFinish: --:--\nDuration (mm:ss): --:--\n\n`;
          } else {
            breakLog.forEach((b, i) => {
              const duration = b.end - b.start;
              text += `${ordinal(i + 1)} Break:\n`;
              text += `Start: ${formatTime24(b.start)}\n`;
              text += `Finish: ${formatTime24(b.end)}\n`;
              text += `Duration (mm:ss): ${formatDuration(duration)}\n\n`;
            });
          }

          // SHIFT END (only if user ended the shift)
          if (shiftEndTime) {
            text += `Shift End Date: ${formatDateWithOrdinal(shiftEndTime)}\n`;
            text += `Shift End Time: ${formatTime24(shiftEndTime)}\n\n`;
          }

          // TOTAL WORKED MINUS BREAKS
          const now = Date.now();
          const totalWorkedMs = startTime ? now - startTime : 0;
          const totalBreakMs = breakLog.reduce(
            (sum, b) => sum + (b.end - b.start),
            0
          );

          const workedMinusBreaks = totalWorkedMs - totalBreakMs;

          text += `Total Time Worked (minus breaks): ${formatHM(
            workedMinusBreaks
          )} (hh:mm)\n`;

          return text;
        }

        // SAVE / DELETE MODAL LOGIC
        document
          .getElementById("saveShiftBtn")
          .addEventListener("click", () => {
            shiftEndTime = Date.now();
            document.getElementById("endShiftModal").style.display = "none";
            document.getElementById("saveOptionsModal").style.display = "flex";
          });

        document
          .getElementById("deleteShiftBtn")
          .addEventListener("click", () => {
            shiftEndTime = Date.now();
            document.getElementById("endShiftModal").style.display = "none";
            endShift();
          });

        // SAVE OPTIONS
        // Email
        document.getElementById("saveEmail").addEventListener("click", () => { 
          const body = encodeURIComponent(generateShiftTextSummary()); 
          window.location.href = `mailto:?subject=Shift Summary&body=${body}`; 
          // Close save options and return to Save/Delete modal 
          document.getElementById("saveOptionsModal").style.display = "none"; 
          document.getElementById("endShiftModal").style.display = "flex"; });

        // Whatsapp
        document.getElementById("saveWhatsApp").addEventListener("click", () => { 
          const msg = encodeURIComponent(generateShiftTextSummary()); 
          window.open(`https://wa.me/?text=${msg}`);
          // Close save options and return to Save/Delete modal
          document.getElementById("saveOptionsModal").style.display = "none"; 
          document.getElementById("endShiftModal").style.display = "flex"; });

        // Text File
        document.getElementById("saveTextFile").addEventListener("click", () => {
          // Format date for filename
          const d = new Date(startTime);   // shift start date
          const weekday = d.toLocaleDateString("en-GB", { weekday: "short" });
          const month = d.toLocaleDateString("en-GB", { month: "short" });
          const day = d.getDate();

          // ordinal helper
          function ordinal(n) {
            return n === 1 ? "1st" :
                  n === 2 ? "2nd" :
                  n === 3 ? "3rd" : `${n}th`;
          }

          const formattedDate = `${weekday}_${ordinal(day)}_${month}_${d.getFullYear()}`;

          const filename = `shift_data_${formattedDate}.txt`;

          // Create file
          const blob = new Blob([generateShiftTextSummary()], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);

          // Close save options and return to Save/Delete modal
          document.getElementById("saveOptionsModal").style.display = "none";
          document.getElementById("endShiftModal").style.display = "flex";
        });

        document
          .getElementById("closeSaveOptions")
          .addEventListener("click", () => {
            document.getElementById("saveOptionsModal").style.display = "none";
          });

        // Close the Save/Delete modal without taking action
        document.getElementById("cancelEndShiftModal").addEventListener("click", () => {
          shiftEndTime = null;
          document.getElementById("endShiftModal").style.display = "none";
        });

        // BREAK BUTTONS
        document
          .getElementById("startBreakBtn")
          .addEventListener("click", () => {
            if (!startTime) return;
            if (!currentBreakStart) {
              currentBreakStart = Date.now();
              localStorage.setItem("currentBreakStart", currentBreakStart);
              updateBreakButtons();
            }
          });

        document.getElementById("endBreakBtn").addEventListener("click", () => {
          if (!startTime) return;
          if (currentBreakStart) {
            const end = Date.now();
            const duration = end - currentBreakStart;

            if (duration >= 15 * 60 * 1000) {
              breakLog.push({ start: currentBreakStart, end });
              localStorage.setItem("breakLog", JSON.stringify(breakLog));
            }

            currentBreakStart = null;
            localStorage.removeItem("currentBreakStart");

            updateBreakButtons();
          }
        });

        // START SHIFT BUTTON TOGGLE
        const startShiftBtn = document.getElementById("startShiftBtn");
        startShiftBtn.addEventListener("click", () => {
          if (!startTime) {
            startShift();
          } else {
            confirmEndShift();
          }
        });

        // BREAK INFO MODAL
        document
          .getElementById("breakInfoBtn")
          .addEventListener("click", () => {
            document.getElementById("breakInfoModal").style.display = "flex";
          });

        document
          .getElementById("closeBreakInfo")
          .addEventListener("click", () => {
            document.getElementById("breakInfoModal").style.display = "none";
          });

        document
          .getElementById("breakInfoModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "breakInfoModal") {
              document.getElementById("breakInfoModal").style.display = "none";
            }
          });

        // SUMMARY MODAL
        function updateSummaryModal() {
          const container = document.getElementById("summaryContent");
          container.innerHTML = "";

          const now = Date.now();
          const totalWorkedMs = startTime ? now - startTime : 0;

          let totalBreakMs = 0;

          // SHIFT START TIME + DATE
          container.innerHTML += `
            <h3>Shift Start</h3>
            <p>Date: ${startTime ? formatDateWithOrdinal(startTime) : "--"}</p>
            <p>Time: ${startTime ? formatTime24(startTime) : "--:--"}</p>
            <hr>
          `;

          // SHIFT END (only shown if user actually ended the shift)
          if (shiftEndTime) {
            container.innerHTML += `
              <h3>Shift End</h3>
              <p>Date: ${formatDateWithOrdinal(shiftEndTime)}</p>
              <p>Time: ${formatTime24(shiftEndTime)}</p>
              <hr>
            `;
          }

          // BREAKS
          if (breakLog.length === 0) {
            container.innerHTML += `
              <h3>1st Break</h3>
              <p>Start Time: --:--</p>
              <p>Finish Time: --:--</p>
              <p>Duration (mm:ss): --:--</p>
              <hr>
            `;
          } else {
            breakLog.forEach((b, i) => {
              const duration = b.end - b.start;
              totalBreakMs += duration;

              container.innerHTML += `
                <h3>${ordinal(i + 1)} Break</h3>
                <p>Start Time: ${formatTime24(b.start)}</p>
                <p>Finish Time: ${formatTime24(b.end)}</p>
                <p>Duration (mm:ss): ${formatDuration(duration)}</p>
                <hr>
              `;
            });
          }

          // TOTAL WORKED MINUS BREAKS
          const workedMinusBreaks = totalWorkedMs - totalBreakMs;

          container.innerHTML += `
            <h3>Total Time Worked (minus breaks)</h3>
            <p>(hh:mm): ${formatHM(workedMinusBreaks)}</p>
          `;
        }

        document.getElementById("summaryBtn").onclick = () => {
          updateSummaryModal();
          document.getElementById("summaryModal").style.display = "flex";
        };

        document.getElementById("summaryClose").onclick = () => {
          document.getElementById("summaryModal").style.display = "none";
        };

        document
          .getElementById("summaryModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "summaryModal") {
              document.getElementById("summaryModal").style.display = "none";
            }
          });

        // INITIALISE UI
        if (startTime) {
          startShiftBtn.textContent = "End Shift";
          startShiftBtn.classList.add("end-shift");
          startTimers();
        } else {
          startShiftBtn.textContent = "Start Shift";
          startShiftBtn.classList.remove("end-shift");
        }

        updateBreakButtons();
      })();
    </script>
  </body>
</html>


